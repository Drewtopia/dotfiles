{{- if and (eq .chezmoi.os "windows") .dev_computer -}}
# PowerShell Profile - Dev Tools (sourced from OneDrive profile)

# Add mise shims to PATH if mise is installed
$miseShimPath = "$env:USERPROFILE\AppData\Local\mise\shims"
if (Test-Path $miseShimPath) {
    $currentPath = $env:PATH -split ';'
    if ($miseShimPath -notin $currentPath) {
        $env:PATH = "$miseShimPath;$env:PATH"
    }

    if (Get-Command mise -ErrorAction SilentlyContinue) {
        mise activate pwsh | Out-String | Invoke-Expression
    }
}

# pnpm global packages setup
$pnpmHome = "$env:USERPROFILE\.local\share\pnpm"
if (Test-Path $pnpmHome) {
    $currentPath = $env:PATH -split ';'
    if ($pnpmHome -notin $currentPath) {
        $env:PATH = "$pnpmHome;$env:PATH"
    }
}

# Carapace - multi-shell completion engine
if (Get-Command carapace -ErrorAction SilentlyContinue) {
    $env:CARAPACE_BRIDGES = 'zsh,fish,bash,inshellisense'
    Set-PSReadLineOption -Colors @{ "Selection" = "`e[7m" }
    Set-PSReadlineKeyHandler -Key Tab -Function MenuComplete
    carapace _carapace | Out-String | Invoke-Expression
}

# Zoxide - smarter cd command
if (Get-Command zoxide -ErrorAction SilentlyContinue) {
    Invoke-Expression (& { (zoxide init powershell | Out-String) })
}

# Atuin - shell history (requires atuin 18.11+)
$atuinPath = "$env:USERPROFILE\.atuin\bin"
if (Test-Path $atuinPath) {
    $currentPath = $env:PATH -split ';'
    if ($atuinPath -notin $currentPath) {
        $env:PATH = "$atuinPath;$env:PATH"
    }
}
if (Get-Command atuin -ErrorAction SilentlyContinue) {
    Invoke-Expression (& { (atuin init powershell | Out-String) })
}

# PowerToys CommandNotFound module
if (Get-Module -ListAvailable -Name Microsoft.WinGet.CommandNotFound) {
    Import-Module -Name Microsoft.WinGet.CommandNotFound
}
{{- end }}