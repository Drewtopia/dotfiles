#!/bin/bash

set -eufo pipefail

{{ if .dev_computer -}}
echo "üì¶ Installing global packages via pnpm..."

# Activate mise to make pnpm available
if command -v mise >/dev/null 2>&1; then
    eval "$(mise activate bash)"
else
    echo "‚ö†Ô∏è  mise not found. Cannot activate development tools."
    exit 1
fi

# Mise tools should already be installed by platform-specific scripts
# Now check if pnpm is available
if ! command -v pnpm >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  pnpm still not found after mise install."
    exit 1
fi

# PNPM environment is handled by shell/mise.sh permanently
# Just ensure pnpm works for this session by activating mise
if command -v pnpm >/dev/null 2>&1; then
    echo "‚úÖ pnpm is available via mise"
    
    # Configure PNPM_HOME for global packages (managed by shell/mise.sh template)
    export PNPM_HOME="$HOME/.local/share/pnpm"
    mkdir -p "$PNPM_HOME"
    case ":$PATH:" in
        *":$PNPM_HOME:"*) ;;
        *) export PATH="$PNPM_HOME:$PATH" ;;
    esac
else
    echo "‚ö†Ô∏è  pnpm not found - mise activation may have failed"
fi

# Global packages to install
packages=(
    "@google/gemini-cli"
)

for package in "${packages[@]}"; do
    echo "üì¶ Installing/updating $package globally..."
    # Always install to ensure updates and correct location
    pnpm add -g "$package" || echo "‚ö†Ô∏è  Failed to install $package"
done

echo "‚úÖ Global package installation completed!"
{{- else }}
echo "üè† Skipping global packages installation (not a dev computer)"
{{- end }}