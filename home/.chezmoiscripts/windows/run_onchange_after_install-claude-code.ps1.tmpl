{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env pwsh

# Install Claude Code on Windows
# This script runs when its content changes (onchange)

# Ensure ~/.local/bin is in user PATH
$localBin = "$env:USERPROFILE\.local\bin"
$currentPath = [Environment]::GetEnvironmentVariable("Path", "User")

if ($currentPath -notlike "*$localBin*") {
    Write-Host "[Setup] Adding $localBin to user PATH..." -ForegroundColor Blue
    $newPath = "$localBin;$currentPath"
    [Environment]::SetEnvironmentVariable("Path", $newPath, "User")
    $env:Path = "$localBin;$env:Path"
    Write-Host "[OK] Added $localBin to PATH" -ForegroundColor Green
} else {
    Write-Host "[OK] $localBin already in PATH" -ForegroundColor Green
}

# Install Claude Code
Write-Host "[Install] Installing Claude Code..." -ForegroundColor Blue
try {
    irm https://claude.ai/install.ps1 | iex

    if (Get-Command claude -ErrorAction SilentlyContinue) {
        $version = claude --version
        Write-Host "[OK] Claude Code version: $version" -ForegroundColor Green
    }
} catch {
    Write-Host "[ERROR] Claude Code installation failed: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
{{- end -}}
