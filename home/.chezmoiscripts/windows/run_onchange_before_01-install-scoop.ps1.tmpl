{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env pwsh

# Install Scoop package manager and essential tools
# This script runs when its content changes

Write-Host "[Windows] Setting up Scoop package manager..." -ForegroundColor Green

function Test-Command($cmdname) {
    return [bool](Get-Command -Name $cmdname -ErrorAction SilentlyContinue)
}

# Install Scoop if not already installed
if (-not (Test-Command scoop)) {
    Write-Host "[Install] Installing Scoop..." -ForegroundColor Blue
    try {
        # Set execution policy for current user
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

        # Install Scoop
        irm get.scoop.sh | iex

        Write-Host "[OK] Scoop installed successfully" -ForegroundColor Green
    } catch {
        Write-Host "[ERROR] Scoop installation failed: $($_.Exception.Message)" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "[OK] Scoop already installed" -ForegroundColor Green
}

# Add extra buckets for more packages
$buckets = @('extras', 'nerd-fonts')
foreach ($bucket in $buckets) {
    $bucketList = scoop bucket list 2>$null
    if ($bucketList -notcontains $bucket) {
        Write-Host "[Install] Adding Scoop bucket: $bucket" -ForegroundColor Blue
        scoop bucket add $bucket
    } else {
        Write-Host "[OK] Scoop bucket '$bucket' already added" -ForegroundColor Green
    }
}

# Install essential CLI tools via Scoop
$scoopPackages = @(
    'fzf',
    'fd',
    'zoxide',
    'ripgrep',
    'bat',
    'eza',
    'delta',
    'jq',
    'carapace-bin'
)

# Get list of installed packages once
$installedPackages = scoop list 2>$null | ForEach-Object { $_.Name }

Write-Host "[Install] Installing essential CLI tools via Scoop..." -ForegroundColor Blue
foreach ($package in $scoopPackages) {
    if ($package -notin $installedPackages) {
        Write-Host "Installing $package..." -ForegroundColor Cyan
        scoop install $package
    } else {
        Write-Host "[OK] $package already installed" -ForegroundColor Green
    }
}

Write-Host "[OK] Scoop setup completed!" -ForegroundColor Green
{{- end }}