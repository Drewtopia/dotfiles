#!/bin/bash

set -eufo pipefail

{{ $brews := list
    "age"
    "bat"
    "btop"
    "curl"
    "dockutil"
    "eza"
    "fd"
    "ffmpeg"
    "fzf"
    "gdu"
    "gh"
    "git"
    "git-delta"
    "git-lfs"
	"glow"
    "gnu-units"
    "gnupg"
    "golangci-lint"
    "jless"
    "jq"
	"lazygit"
	"mas"
    "node"
    "pkg-config"
    "ripgrep"
    "shellcheck"
    "tmux"
    "wget"
    "xz"
    "yt-dlp"
    "zoxide" -}}
{{- /* Node.js back to homebrew due to mise GPG issues */ -}}
{{ $casks := list
	"1password"
    "1password-cli"
    "applite"
	"arc"
    "betterdisplay"
    "bruno"
    "chatgpt"
    "discord"
    "elgato-stream-deck"
    "espanso"
	"fmail3"
    "firefox@developer-edition"
    "font-fira-code"
    "font-fira-code-nerd-font"
    "font-fira-mono-nerd-font"
    "font-jetbrains-mono"
    "font-jetbrains-mono-nerd-font"
    "font-monaspace"
    "font-symbols-only-nerd-font"
    "ghostty"
    "hammerspoon"
    "hazel"
    "iina"
    "imageoptim"
    "iterm2"
    "jdownloader"
    "jordanbaird-ice"
    "jump-desktop-connect"
    "karabiner-elements"
    "keka"
    "keycastr"
    "keyclu"
    "logi-options+"
    "lookaway"
    "lunar"
    "muzzle"
    "obsidian"
    "onyx"
    "orion"
    "plex"
    "raindropio"
    "raycast"
    "rectangle-pro"
    "setapp"
    "spotify"
    "soundsource"
    "syntax-highlight"
    "tailscale"
    "telegram"
    "transmission"
    "unclack"
    "visual-studio-code"
    "vlc"
    "wezterm"
    "zen-browser"
    "qlcolorcode"
    "qlmarkdown"
    "qlprettypatch"
    "qlstephen"
    "qlvideo"
    "quicklook-csv"
    "quicklook-json"
    "webpquicklook" -}}

echo "üçé Installing system packages via Homebrew..."

brew bundle --file=/dev/stdin <<EOF
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF

{{ if .dev_computer -}}
echo "üçé Installing development tools via mise..."

# Install mise (modern runtime version manager)
# Always install/update mise to ensure latest version and correct location
echo "üì¶ Installing/updating mise..."
curl https://mise.run | sh || {
    echo "‚ö†Ô∏è  Mise installation failed"
    exit 1
}

# Add mise to PATH for this session
export PATH="$HOME/.local/bin:$PATH"

# Install development tools via mise (from config.toml)
echo "üì¶ Installing development tools via mise..."
mise install 2>/dev/null || echo "‚ö†Ô∏è  Some mise tools failed to install"

# Install non-mise tools
# Atuin (shell history replacement)
# Always install/update Atuin to ensure latest version and correct location
echo "üì¶ Installing/updating Atuin..."
curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh -s -- --no-modify-path || echo "‚ö†Ô∏è  Atuin installation failed"

echo "‚úÖ Development tools installation completed!"
{{- else }}
echo "üè† Skipping development tools installation (not a dev computer)"
{{- end }}

echo "‚úÖ macOS installation completed!"
