{{ if eq .osid "linux-debian" "linux-raspbian" "linux-ubuntu" -}}

{{ $packages := list
     "age"
     "bat"
     "curl"
     "fd-find"
     "ffmpeg"
     "fzf"
     "gh"
     "git"
     "git-lfs"
     "gnupg"
     "jq"
     "neovim"
     "pkg-config"
     "ripgrep"
     "shellcheck"
     "tmux"
     "units"
     "unzip"
     "wget"
     "xz-utils"
     "zsh" -}}
{{- /* Core dev tools handled by mise: node, pnpm, deno, bun, python, uv, go, rust */ -}}
{{ $snaps := list -}}
{{ $classicSnaps := list -}}

{{ if eq .osid "linux-ubuntu" -}}
{{   $packages = mustAppend $packages "btop" -}}
{{ end -}}

{{ if not .headless -}}
{{   $packages = mustAppend $packages "xclip" -}}
{{   $classicSnaps = mustAppend $classicSnaps "code" -}}
{{ end -}}

{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
{{   $sudo = "" -}}
{{ end -}}

#!/bin/bash

set -eufo pipefail

echo "ğŸ§ Installing system packages on Linux..."

{{ $sudo }}apt-get update
{{ $sudo }}apt-get install -y {{ $packages | join " " }}

{{ if lookPath "snap" }}
{{   range $snaps }}
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install {{ . }}
{{   end }}
{{   range $classicSnaps }}
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install --classic {{ . }}
{{   end }}
{{ end }}

# Install zoxide (better cd command)
if ! command -v zoxide >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing zoxide..."
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

{{ if .dev_computer -}}
echo "ğŸ§ Installing development tools via mise..."

# Install mise (modern runtime version manager)
if ! command -v mise >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing mise..."
    curl https://mise.run | sh || {
        echo "âš ï¸  Mise installation failed"
        exit 1
    }
    
    # Add mise to PATH for this session
    export PATH="$HOME/.local/bin:$PATH"
else
    echo "âœ… Mise already installed"
fi

# Install development tools via mise (from config.toml)
echo "ğŸ“¦ Installing development tools via mise..."
mise install 2>/dev/null || echo "âš ï¸  Some mise tools failed to install"

# Install non-mise tools
# Atuin (shell history replacement) 
if ! command -v atuin >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing Atuin..."
    curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh || echo "âš ï¸  Atuin installation failed"
else
    echo "âœ… Atuin already installed"
fi

echo "âœ… Development tools installation completed!"
{{- else }}
echo "ğŸ  Skipping development tools installation (not a dev computer)"
{{- end }}

echo "âœ… Linux installation completed!"

{{ end -}}
