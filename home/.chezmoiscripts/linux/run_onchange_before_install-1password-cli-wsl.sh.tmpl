{{- if and .is_wsl .dev_computer -}}
#!/bin/bash

# Install 1Password CLI symlink for WSL2
echo "Setting up 1Password CLI symlink for WSL2..."

# Get the Windows username
WINDOWS_USER=$(powershell.exe -c "echo \$env:USERNAME" 2>/dev/null | tr -d '\r\n')

if [ -z "$WINDOWS_USER" ]; then
    echo "Error: Could not determine Windows username"
    exit 1
fi

# Possible locations for 1Password CLI on Windows
WINGET_PATH="/mnt/c/Users/$WINDOWS_USER/AppData/Local/Microsoft/WinGet/Packages"
WINGET_LINKS_PATH="/mnt/c/Users/$WINDOWS_USER/AppData/Local/Microsoft/WinGet/Links/op.exe"
PROGRAM_FILES_PATH="/mnt/c/Program Files/1Password CLI/op.exe"

# Create ~/.local/bin if it doesn't exist
mkdir -p "$HOME/.local/bin"

OP_PATH=""

# Check for op.exe in common locations
if [ -f "$WINGET_LINKS_PATH" ]; then
    OP_PATH="$WINGET_LINKS_PATH"
    echo "Found 1Password CLI at: $WINGET_LINKS_PATH"
elif [ -f "$PROGRAM_FILES_PATH" ]; then
    OP_PATH="$PROGRAM_FILES_PATH"
    echo "Found 1Password CLI at: $PROGRAM_FILES_PATH"
elif [ -d "$WINGET_PATH" ]; then
    # Search for op.exe in WinGet packages directory
    OP_FOUND=$(find "$WINGET_PATH" -name "op.exe" -type f 2>/dev/null | head -1)
    if [ -n "$OP_FOUND" ]; then
        OP_PATH="$OP_FOUND"
        echo "Found 1Password CLI at: $OP_PATH"
    fi
fi

if [ -z "$OP_PATH" ]; then
    echo "Error: 1Password CLI not found. Please install it on Windows first using:"
    echo "  winget install AgileBits.1PasswordCLI"
    echo "Or manually download from 1Password website"
    exit 1
fi

# Create symlink
SYMLINK_PATH="$HOME/.local/bin/op"
if [ -L "$SYMLINK_PATH" ]; then
    echo "Removing existing symlink..."
    rm "$SYMLINK_PATH"
fi

ln -s "$OP_PATH" "$SYMLINK_PATH"

if [ $? -eq 0 ]; then
    echo "Successfully created symlink: $SYMLINK_PATH -> $OP_PATH"
    echo "Make sure ~/.local/bin is in your PATH"
    
    # Test the symlink
    if "$SYMLINK_PATH" --version >/dev/null 2>&1; then
        echo "✓ 1Password CLI is working correctly"
    else
        echo "⚠ Warning: Symlink created but 1Password CLI test failed"
    fi
else
    echo "Error: Failed to create symlink"
    exit 1
fi
{{- end -}}