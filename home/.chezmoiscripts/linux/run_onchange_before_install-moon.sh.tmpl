{{- if and (eq .chezmoi.os "linux") .is_wsl -}}
#!/bin/bash

set -eufo pipefail

# Install Moon via Proto on WSL2 only
# This script runs when the hash changes (onchange)

echo "Installing Moon via Proto on WSL2..."

# Ensure proto is available
if ! command -v proto >/dev/null 2>&1; then
    echo "Error: Proto must be installed first"
    exit 1
fi

# Check if Moon is already installed via proto
if proto status --config-mode all | grep -q "moon"; then
    echo "Moon is already installed via proto: $(proto run moon -- --version)"
    exit 0
fi

# Install Moon via proto
echo "Installing Moon via proto..."
proto install moon

# Verify installation
if proto status --config-mode all | grep -q "moon"; then
    echo "Moon installed successfully via proto: $(proto run moon -- --version)"
    echo "Moon is available at ~/.proto/bin/moon and via 'proto run moon'"
else
    echo "Error: Moon installation via proto failed"
    exit 1
fi
{{- end }}