# PATH management utilities

{{- if .is_wsl }}
# WSL2: Prioritize Linux tools over Windows tools while keeping both available
prioritize_wsl_paths() {
    local wsl_paths=()
    local windows_paths=()
    local dir

    for dir in $path; do
        # Separate Windows paths from WSL paths
        if [[ "$dir" =~ ^/mnt/[a-zA-Z]/ ]]; then
            windows_paths+=("$dir")
        else
            wsl_paths+=("$dir")
        fi
    done

    # Rebuild path with WSL paths first, then Windows paths
    path=($wsl_paths $windows_paths)
}

# WSL2: Filter out Windows tool paths that conflict with Linux tools
# Keep: VS Code, Docker, Windows system, 1Password CLI
# Remove: All dev tools that have Linux equivalents
filter_windows_tool_paths() {
    local filtered_path=()
    local dir

    for dir in "${path[@]}"; do
        # Skip if not a Windows path
        if [[ ! "$dir" =~ ^/mnt/[a-zA-Z]/ ]]; then
            filtered_path+=("$dir")
            continue
        fi

        # KEEP these Windows paths (useful integrations)
        if [[ "$dir" =~ "Microsoft VS Code" ]] ||
           [[ "$dir" =~ "Docker" ]] ||
           [[ "$dir" =~ "1Password" ]] ||
           [[ "$dir" =~ "/mnt/c/Windows" ]]; then
            filtered_path+=("$dir")
            continue
        fi

        # REMOVE everything else from Windows (dev tools that conflict)
        # This includes: mise, scoop, pnpm, node, fzf, deno, go, etc.
        # They all have Linux equivalents via mise/apt/brew
    done

    path=("${filtered_path[@]}")
}
{{- end }}

# Function to safely add to PATH without duplicates (modern array syntax)
path_add() {
    local dir="$1"
    # Remove trailing slash
    dir="${dir%/}"

    # Skip if directory doesn't exist
    [[ -d "$dir" ]] || return 1

    # Use array syntax for better performance and reliability
    # Check if already in path array
    if [[ ! " ${path[*]} " =~ " ${dir} " ]]; then
        path=("$dir" $path)
    fi
}

# Function to safely add to FPATH without duplicates (for zsh completions)
fpath_add() {
    local dir="$1"
    # Remove trailing slash
    dir="${dir%/}"

    # Skip if directory doesn't exist or not in zsh
    [[ -d "$dir" ]] || return 1
    [[ -n "${ZSH_VERSION:-}" ]] || return 1

    # Check for duplicates in fpath array
    if [[ ! " ${fpath[*]} " =~ " ${dir} " ]]; then
        fpath=("$dir" $fpath)
    fi
}

# Function to safely add to MANPATH without duplicates
manpath_add() {
    local dir="$1"
    # Remove trailing slash
    dir="${dir%/}"

    # Skip if directory doesn't exist
    [[ -d "$dir" ]] || return 1

    # Use array syntax for better performance
    if [[ ! " ${manpath[*]} " =~ " ${dir} " ]]; then
        manpath=("$dir" $manpath)
    fi
}

# Note: PATH deduplication is handled automatically by typeset -aU in .zshrc

# Load paths in priority order
load_paths() {
    # 1. Priority paths (highest priority - pnpm, critical tools)
    [[ -f "${XDG_CONFIG_HOME}/shell/paths/priority.paths.sh" ]] && \
        source "${XDG_CONFIG_HOME}/shell/paths/priority.paths.sh"
    
    # 2. Default system paths (essential system directories)
    [[ -f "${XDG_CONFIG_HOME}/shell/paths/default.paths.sh" ]] && \
        source "${XDG_CONFIG_HOME}/shell/paths/default.paths.sh"
    
    # 3. Custom paths (user-specific, tool managers)
    [[ -f "${XDG_CONFIG_HOME}/shell/paths/custom.paths.sh" ]] && \
        source "${XDG_CONFIG_HOME}/shell/paths/custom.paths.sh"
    
    # 4. Load completion paths (zsh only)
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        # Oh My Zsh completions directory
        fpath_add "$HOME/.oh-my-zsh/completions"
        
        # System completion directories (if they exist)
        fpath_add "/usr/local/share/zsh/site-functions"
        fpath_add "/opt/homebrew/share/zsh/site-functions"
    fi
    
    # 5. PATH deduplication happens automatically via typeset -aU
    
{{- if .is_wsl }}
    # 6. WSL2: Filter out conflicting Windows tool paths
    filter_windows_tool_paths

    # 7. WSL2: Reorder remaining PATH to prioritize Linux tools over Windows tools
    prioritize_wsl_paths
{{- end }}
}

